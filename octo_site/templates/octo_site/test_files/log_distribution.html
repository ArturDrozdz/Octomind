<!doctype html>
<html>

<head>
	<title>Scatter Chart</title>
    {% load staticfiles %}
	<script src="{% static 'octo_site/res/Chart.js/Chart.bundle.js' %}"></script>
	<script src="{% static 'octo_site/res/Chart.js/samples/utils.js' %}"></script>
    <script src="{% static 'octo_site/res/jquery.js' %}"></script>
	<style>
	canvas {
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body>
	<div style="width:75%">
		<canvas id="canvas"></canvas>
	</div>
	<button id="randomizeData">Randomize Data</button>
	<script>
		var color = Chart.helpers.color;
		var log_dist_sensors=[];
		let distribution_data = null;
		var colorNames = Object.keys(window.chartColors);

		var scatterChartData = {
			datasets: [],
            game_ids:[],
		};
		var yLbl = {
        {% for game in games %}
            {{ forloop.counter }} : 'Game #'+(100000 + {{ game.game_id }}),
        {% endfor %}
        };


		window.onload = function() {
			var ctx = document.getElementById('canvas').getContext('2d');

			window.LogDistributionChart = Chart.Scatter(ctx, {
				data: scatterChartData,
				options: {
					title: {
						display: true,
						text: 'Sensor Log Distribution for Game/s {{ game_ids|join:", " }}'
					},

				    tooltips: {
					mode: 'nearest',
					intersect: false,
                    custom: function(tooltip) {
                    if (!tooltip) return;
                    // disable displaying the color box;
                    tooltip.displayColors = true;
                    },
                    callbacks: {
                        // use label callback to return the desired label
                        label: function(tooltipItem, data) {
                            val = tooltipItem.xLabel;
                            sec = ((val % 1)*60).toFixed(2);

                            min = Math.floor(val);
                            if (min !== 0 && sec !== 0){
                            if (parseInt(sec) === 0){
                                    return 'Elapsed: ' + min + " min";
                                }
                                return min + " min and " + sec +" sec" ;
                            }
                            return 'Ano daw';
                        },
                        title: function(tooltipItem, data) {
                            return data.datasets[tooltipItem[0].datasetIndex].label

                        },
                        afterTitle: function(tooltipItem, data) {
                            return "Game "+(parseInt(tooltipItem[0].yLabel)+100000);

                        },

                        // Use the footer callback to display the sum of the items showing in the tooltip

                      },
                    /*
                    callbacks: {

					},
                    */
					footerFontStyle: 'normal'
				},
                    scales: {
                        xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'minutes',
                                max: 60
                            }
                        }],
                        yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                            },
                            ticks: {
                                beginAtZero: true,
                                steps: 0,
                                min: 0,
                                stepValue: 5,
                                max: {{ games|length }}.00001,
                                callback: function(value, index, values){
                                    return yLbl[value];
                                }
                            }
                        }]
                    }

				}
			});
			initData();
		};

        function initData() {
            console.log("ylabels",yLbl);
            // Populate the datasets
         let sensor_data =  $.get("/octo_site/api/get_sensor_by_room_id/{{ room.room_id }}/");
             sensor_data.done(function(results){
                obj = results.sensors;
                for (i in obj)
                {
                   colorName = colorNames[scatterChartData.datasets.length % colorNames.length];
                   newColor = window.chartColors[colorName];
                   newDataset = {
                        label: obj[i].sensor_name,
                        backgroundColor: color(newColor).alpha(0.2).rgbString(),
                        borderColor: newColor,
                        data: [],
                        pointRadius: 8,
                        pointHoverRadius: 14,
                   };
                   scatterChartData.datasets.push(newDataset);
                   log_dist_sensors.push(obj[i].sensor_id);
                   window.LogDistributionChart.update()
                }
           });
           // Populate data in the datasets
         {% for game in games %}
             scatterChartData.game_ids.push({{ forloop.counter }});
             distribution_data =  $.get("/octo_site/sensor_data/{{ game.game_id }}/");
             distribution_data.done(function(results){
                obj = results.data;
                for (i in obj)
                {
                   if(obj[i].value !== "0"){
                       scatterChartData.datasets[log_dist_sensors.indexOf(obj[i].sensor_id)].data.push({x:obj[i].min_stamped,y: {{forloop.counter}} });
                       window.LogDistributionChart.update()
                   }
                }

            });
         {% endfor %}

        }

		document.getElementById('randomizeData').addEventListener('click', function() {
			scatterChartData.datasets.forEach(function(dataset) {
				dataset.data = dataset.data.map(function() {
					return {
						x: randomScalingFactor(),
						y: randomScalingFactor()
					};
				});
			});
			window.LogDistributionChart.update();
		});
	</script>
</body>

</html>
