<!doctype html>
<html>
{% load staticfiles %}
<head>
	<title>Line Chart</title>
	<script src="{% static 'octo_site/res/Chart.js/Chart.bundle.js' %}"></script>
	<script src="{% static 'octo_site/res/Chart.js/samples/utils.js' %}"></script>
    <script src="{% static 'octo_site/res/jquery.js' %}"></script>
    <script src="{% static 'octo_site/res/jsocket.js' %}"></script>
	<style>
	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body>
	<div style="width:75%;">
		<canvas id="canvas"></canvas>
	</div>
	<br>
    <script>
		var DEFAULT_DATASET_SIZE = 7;
        var log_sum_sensors=[];
        var summary_data = null;
        let chartColors = {
          red: 'rgb(255, 99, 132)',
          orange: 'rgb(255, 159, 64)',
          yellow: 'rgb(255, 205, 86)',
          green: 'rgb(75, 192, 192)',
          blue: 'rgb(54, 162, 235)',
          purple: 'rgb(153, 102, 255)',
          grey: 'rgb(231,233,237)',
          black: 'rgb(0,0,0)',
        };
		var colorNames = Object.keys(chartColors);
		var color = Chart.helpers.color;
		var bubbleChartData = {
			animation: {
				duration: 0
			},
            game_ids: [],
			datasets: [],
            dataset_game_ids:[],
            dataset_r_vals:[]

		};

		window.onload = function() {
			var ctx = document.getElementById('canvas').getContext('2d');
			window.myLogSummary = new Chart(ctx, {
				type: 'bubble',
				data: bubbleChartData,
				options: {
					responsive: true,
					title: {
						display: true,
						text: 'Log Summary for Game/s {{ game_ids|join:", " }}'
					},
					tooltips: {
						mode: 'nearest',
                        intersect: false,
                        custom: function(tooltip) {
                        if (!tooltip) return;
                            // disable displaying the color box;
                            tooltip.displayColors = true;
                        },
                        callbacks: {
                            // use label callback to return the desired label
                            label: function(tooltipItem, data) {
                                val = tooltipItem.xLabel;
                                sec = ((val % 1)*60).toFixed(2);

                                min = Math.floor(val);
                                if (min !== 0 && sec !== 0){
                                if (parseInt(sec) === 0){
                                        return min + ":00";
                                    }
                                    return min + ":" + Math.round(sec) ;
                                }
                                return 'Ano daw';
                            },
                            title: function(tooltipItem, data) {
                                return data.datasets[tooltipItem[0].datasetIndex].label

                            },
                            afterTitle: function(tooltipItem, data) {
                                return "Game "+(10000+data.dataset_game_ids[1][tooltipItem[0].index]);
                            },
                            afterBody: function(tooltipItem, data) {

                                console.log(tooltipItem[0]);
                                console.log(data);
                                val = parseFloat(tooltipItem[0].yLabel);
                                sec = ((val % 1)*60).toFixed(2);

                                min = Math.floor(val);
                                if (min !== 0 && sec !== 0){
                                if (parseInt(sec) === 0){
                                        return 'Solved in ' + min + " min";
                                    }
                                    return "Solved in "+min + " min and " + Math.round(sec) +" sec" ;
                                }
                                return 'Ano daw';
                            },
                            beforeBody: function(tooltipItem, data) {

                                console.log("d set",tooltipItem);
                                console.log("d set",data);
                                //console.log("d set",data.dataset_r_vals);
                                //console.log(data.dataset_r_vals[tooltipItem[0].datasetIndex][tooltipItem[0].index]);
                                    return "Trigger Frequency: "+data.dataset_r_vals[tooltipItem[0].datasetIndex+1][tooltipItem[0].index];
                            },

                            // Use the footer callback to display the sum of the items showing in the tooltip

                          },
                        footerFontStyle: 'normal'
					},
                    scales: {
					    xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'minutes triggered',
                                max: 60
                            }
                        }],
                        yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString:'time solved (min)'
                            }
                        }]
                    }
				}
			});
			initData();
			placeAvg()
		};
		function placeAvg(){

         window.myLogSummary.update()
        }
        function initData(){
            // Populate the datasets
         let sensor_data =  $.get("/octo_site/api/get_sensor_by_room_id/{{ room.room_id }}/");
             sensor_data.done(function(results){
                obj = results.sensors;
                for (i in obj)
                {
                   colorName = colorNames[bubbleChartData.datasets.length % colorNames.length];
                   newColor = window.chartColors[colorName];
                   newDataset = {
                        label: obj[i].sensor_name,
                        backgroundColor: color(newColor).alpha(0.2).rgbString(),
                        borderColor: newColor,
                        data: [],
                        pointRadius: 8,
                        pointHoverRadius: 14,
                   };
                   bubbleChartData.datasets.push(newDataset);
                   let ace = obj[i].sensor_id;
                   bubbleChartData.dataset_game_ids[ace] = [];
                   bubbleChartData.dataset_r_vals[ace] = [];
                   log_sum_sensors.push(obj[i].sensor_id);
                   window.myLogSummary.update()
                }
                /*
                newdt = {
                        label: "averages",
                        type: "line",
                        backgroundColor: color(newColor).alpha(0.2).rgbString(),
                        borderColor: newColor,
                        data: [{x: 10, y: 4,},{x: 23, y: 4,},{x: 40, y: 4,},{x: 50, y: 4,}
                               ],
                        pointRadius: 4,
                        fill: false,
                   };
               console.log("data",bubbleChartData.datasets);
               bubbleChartData.datasets.push(newdt);
                */
                   window.myLogSummary.update()

           });
             console.log(bubbleChartData.dataset_game_ids);
           // Populate data in the datasets
         {% for game in games %}
             summary_data =  $.get("/octo_site/api/game_cur_logs/{{ game.game_id }}/");
             summary_data.done(function(results){
                obj = results.data;
                for (i in obj)
                {
                   if(obj[i].value !== "0"){
                        console.log(obj[i].time_solved);
                       bubbleChartData.datasets[log_sum_sensors.indexOf(obj[i].sensor_id)].data.push(
                           {
                               x: obj[i].min_stamped,
                               y: obj[i].time_solved,
                               r:obj[i].times_triggered*15
                           });
                       bubbleChartData.dataset_r_vals[obj[i].sensor_id].push(obj[i].times_triggered);
                       bubbleChartData.dataset_game_ids[obj[i].sensor_id].push({{ game.game_id }} );
                       window.myLogSummary.update()
                   }
                }
            });
         {% endfor %}
        }
	</script>
</body>

</html>
